-- People + Departments schema alignment for Supabase
-- Date: 2026-02-11
-- Safe to re-run (idempotent)

begin;

-- =========================================================
-- 1) Departments table alignment
-- =========================================================
create table if not exists public.departments (
  id integer generated by default as identity primary key,
  code text,
  name text,
  department_type text,
  status text default 'Active',
  color text,
  "order" integer,
  tags text[] default '{}'::text[],
  people text[] default '{}'::text[],
  thumbnail_url text,
  image_source_entity text,
  created_by uuid,
  updated_by uuid,
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now()
);

alter table public.departments add column if not exists code text;
alter table public.departments add column if not exists name text;
alter table public.departments add column if not exists department_type text;
alter table public.departments add column if not exists status text default 'Active';
alter table public.departments add column if not exists color text;
alter table public.departments add column if not exists "order" integer;
alter table public.departments add column if not exists tags text[] default '{}'::text[];
alter table public.departments add column if not exists people text[] default '{}'::text[];
alter table public.departments add column if not exists thumbnail_url text;
alter table public.departments add column if not exists image_source_entity text;
alter table public.departments add column if not exists created_by uuid;
alter table public.departments add column if not exists updated_by uuid;
alter table public.departments add column if not exists created_at timestamptz not null default now();
alter table public.departments add column if not exists updated_at timestamptz not null default now();

create index if not exists idx_departments_name on public.departments ("name");
create index if not exists idx_departments_code on public.departments (code);
create index if not exists idx_departments_status on public.departments (status);

-- =========================================================
-- 2) People (profiles) table alignment
-- =========================================================
alter table public.profiles add column if not exists firstname text;
alter table public.profiles add column if not exists lastname text;
alter table public.profiles add column if not exists display_name text;
alter table public.profiles add column if not exists login text;
alter table public.profiles add column if not exists password_set boolean default false;
alter table public.profiles add column if not exists password_strength double precision;
alter table public.profiles add column if not exists projects text[] default '{}'::text[];
alter table public.profiles add column if not exists tags text[] default '{}'::text[];
alter table public.profiles add column if not exists avatar_url text;
alter table public.profiles add column if not exists role text default 'member';
alter table public.profiles add column if not exists status text default 'Active';
alter table public.profiles add column if not exists active boolean default true;
alter table public.profiles add column if not exists login_enabled boolean default true;
alter table public.profiles add column if not exists department_id integer;
alter table public.profiles add column if not exists created_by uuid;
alter table public.profiles add column if not exists updated_by uuid;
alter table public.profiles add column if not exists created_at timestamptz not null default now();
alter table public.profiles add column if not exists updated_at timestamptz not null default now();

do $$
begin
  if not exists (
    select 1
    from pg_constraint
    where conname = 'profiles_department_id_fkey'
  ) then
    alter table public.profiles
      add constraint profiles_department_id_fkey
      foreign key (department_id)
      references public.departments(id)
      on delete set null;
  end if;
end $$;

create index if not exists idx_profiles_department_id on public.profiles (department_id);

-- =========================================================
-- 3) Backfill reasonable defaults
-- =========================================================
update public.profiles
set login = email
where login is null
  and email is not null;

update public.profiles
set display_name = coalesce(
  nullif(display_name, ''),
  nullif(trim(concat_ws(' ', firstname, lastname)), ''),
  split_part(email, '@', 1)
)
where display_name is null
   or display_name = '';

update public.profiles
set status = case when coalesce(active, true) then 'Active' else 'Inactive' end
where status is null
   or status = '';

-- =========================================================
-- 4) updated_at trigger helper
-- =========================================================
create or replace function public.set_updated_at()
returns trigger
language plpgsql
as $$
begin
  new.updated_at = now();
  return new;
end;
$$;

do $$
begin
  if not exists (
    select 1 from pg_trigger where tgname = 'trg_departments_set_updated_at'
  ) then
    create trigger trg_departments_set_updated_at
    before update on public.departments
    for each row execute function public.set_updated_at();
  end if;

  if not exists (
    select 1 from pg_trigger where tgname = 'trg_profiles_set_updated_at'
  ) then
    create trigger trg_profiles_set_updated_at
    before update on public.profiles
    for each row execute function public.set_updated_at();
  end if;
end $$;

-- =========================================================
-- 5) RLS read policy for departments (client-side reads)
-- =========================================================
alter table public.departments enable row level security;

do $$
begin
  if not exists (
    select 1 from pg_policies
    where schemaname = 'public'
      and tablename = 'departments'
      and policyname = 'departments_select_authenticated'
  ) then
    create policy departments_select_authenticated
      on public.departments
      for select
      to authenticated
      using (true);
  end if;
end $$;

commit;

-- NOTE:
-- Intentionally no "password" column on profiles.
-- Passwords should remain managed by Supabase Auth only.
